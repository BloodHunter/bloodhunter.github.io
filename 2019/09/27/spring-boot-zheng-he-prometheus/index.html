<!DOCTYPE HTML>
<html lang="">
<head>
    

<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Spring Boot整合Prometheus, wbl">
    <meta name="description" content="Micrometer简介Micrometer 为 Java 平台上的性能数据收集提供了一个通用的 API，应用程序只需要使用 Micrometer 的通用 API 来收集性能指标即可。Micrometer 会负责完成与不同监控系统的适配工作">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Spring Boot整合Prometheus | wbl</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

</head>

<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="container">
            <div class="nav-wrapper">
                <div class="brand-logo">
                    <a href="/" class="waves-effect waves-light">
                        
                        <img src="/medias/logo.jpeg" class="logo-img hide-on-small-only circle">
                        
                        <span class="logo-span">wbl</span>
                    </a>
                </div>
                <a href="#" data-activates="mobile-nav" class="button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li>
        <a id="toggleSearch" class="waves-effect waves-light">
            <i id="searchIcon" class="mdi-action-search"></i>
        </a>
    </li>

</ul>

<div class="side-nav" id="mobile-nav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.jpeg" class="logo-img circle responsive-img">
        
        <div class="logo-name">wbl</div>
        <div class="logo-desc">
            
            每天进步一点点
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/BloodHunter" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>

    <div class="social-link"><a href="https://github.com/BloodHunter" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
    <i class="fa fa-github"></i>
</a>
<a href="mailto:15201414128@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
    <i class="fa fa-envelope-open"></i>
</a>
<a href="#!" class="tooltipped" data-tooltip="QQ联系我: 765759638" data-position="top" data-delay="50">
    <i class="fa fa-qq"></i>
</a>
</div>
</div>

            </div>
        </div>

        
        <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/BloodHunter" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewbox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/>
    </svg>
</a>
        
    </nav>
</header>





<div class="bg-cover post-cover" style="background-image: url('/medias/featureimages/3.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Spring Boot整合Prometheus
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="container content">

    
    <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            
            <div class="article-tag">
                
                <a href="/tags/Spring-Boot/" target="_blank">
                    <span class="chip bg-color">Spring Boot</span>
                </a>
                
            </div>
            
            <div class="post-info">
                
                <span class="post-cate">
                    <i class="fa fa-bookmark fa-fw icon-category"></i>
                    
                    <a href="/categories/Spring-Boot/" class="post-category" target="_blank">
                        Spring Boot
                    </a>
                    
                </span>
                

                <span class="post-date">
                    <i class="fa fa-clock-o fa-fw"></i>2019-09-27
                </span>
            </div>
        </div>
        <hr>
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="Micrometer简介"><a href="#Micrometer简介" class="headerlink" title="Micrometer简介"></a>Micrometer简介</h2><p>Micrometer 为 Java 平台上的性能数据收集提供了一个通用的 API，应用程序只需要使用 Micrometer 的通用 API 来收集性能指标即可。Micrometer 会负责完成与不同监控系统的适配工作。这就使得切换监控系统变得很容易。Micrometer 还支持推送数据到多个不同的监控系统。Micrometer类似日志系统中SLF4J。</p>
<p>Micrometer目前支持的监控系统有<br><img src="https://raw.githubusercontent.com/BloodHunter/blog-comments/master/20190927204237.png" alt=""></p>
<p>Micrometer中有两个最核心的概念，分别是是计量器(Meter)和计量器注册表(MeterRegistry),下面来分别看下这两个概念。</p>
<h3 id="计量器-Meter"><a href="#计量器-Meter" class="headerlink" title="计量器(Meter)"></a>计量器(Meter)</h3><p>Meter用来收集性能指标数据(Metris)，总共有四种类型的Meter，分别是Counter，Gauge，Timer，Summary。</p>
<p>每个Meter都有自己的名称，同时Meter可以指定一系列的tag。tag是以key-value的形式出现，这样我们就可以根据tag对指标进行过滤。除了每个Meter独有的标签外，也可以通过MeterRegistry添加通用的tag。</p>
<pre><code>MeterRegistry.Config config = simpleMeterRegistry.config();
    config.commonTags(&quot;tag1&quot;,&quot;value1&quot;,&quot;tag2&quot;,&quot;value2&quot;);
</code></pre><h4 id="Counter"><a href="#Counter" class="headerlink" title="Counter"></a>Counter</h4><p>Counter只允许增加值，Counter所表示的计数值是double类型，默认情况下增加的值是1.0</p>
<pre><code>@Autowired
private SimpleMeterRegistry simpleMeterRegistry;

@Bean
public Counter counter1(){
    return Counter.builder(&quot;test.count1&quot;).register(simpleMeterRegistry);
}

@Bean
public Counter counter2(){
    return simpleMeterRegistry.counter(&quot;test.count2&quot;);
}

@Test
public void test(){
    counter1.increment();
}
</code></pre><h4 id="Gauge"><a href="#Gauge" class="headerlink" title="Gauge"></a>Gauge</h4><p>Cauge是表示单个的变化的值，例如温度，气压。与Counter的区别在于，Gauge的值不总是增加的</p>
<pre><code>public void guage(){
    Gauge.builder(&quot;guaua1&quot;, this::getValue).register(simpleMeterRegistry);
}

public double getValue(){
    return ThreadLocalRandom.current().nextDouble();
}
</code></pre><p><strong>Gauge对象一旦被创建，就不能手动对其中的值进行修改</strong>。在每次取样时，Gauge 会返回当前值</p>
<h4 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a>Timer</h4><p>Timer通常用来记录事件的持续时间。Timer会记录两类的数据，事件的数量和总的持续时间。Timer提供了不同方式来记录持续时间。第一种方式是使用record()方法来记录Runnable和Callable对象的运行时间，第二种方式是使用Timer.Sample来保存计时状态</p>
<pre><code>public void record(){
    Timer timer = simpleMeterRegistry.timer(&quot;record&quot;);
    timer.record(() -&gt; {
        try {
            Thread.sleep(3000);
        }catch (Exception e){
            e.printStackTrace();
        }
    });
}

public void sample(){
    Timer.Sample sample = Timer.start();
    new Thread(()-&gt;{
        try {
            Thread.sleep(3000);
        }catch (Exception e){
            e.printStackTrace();
        }
        sample.stop(simpleMeterRegistry.timer(&quot;sample&quot;));
    });
}
</code></pre><h4 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h4><p>summary用来记录指标的分布，summary根据每个指标的值，把值分配到对应的bucket中。Micrometer默认的bucket的值从1到Long.MAX_VALUE，可以通过minimumExpectedValue和maximumExpectedValue来控制bucket的范围，如果指标的值较小，还可以通过scale来设置一个值对数值进行放大</p>
<pre><code>public void summary(){
    DistributionSummary summary = DistributionSummary.builder(&quot;summary&quot;)
            .maximumExpectedValue(10L)
            .minimumExpectedValue(1L)
            .publishPercentiles(0.5, 0.75, 0.9)
            .register(simpleMeterRegistry);

    summary.record(1.0);
    summary.record(5.0);
    summary.record(4.5);
    summary.record(3.0);

    System.out.println(summary.takeSnapshot());
}
</code></pre><h3 id="计量器注册表-MeterRegistry"><a href="#计量器注册表-MeterRegistry" class="headerlink" title="计量器注册表(MeterRegistry)"></a>计量器注册表(MeterRegistry)</h3><p>MeterRegistry负责创建和维护Meter。每一个监控系统有自己独有的registry</p>
<p><img src="https://raw.githubusercontent.com/BloodHunter/blog-comments/master/20190929095502.png" alt=""></p>
<p>其中SimpleMeterRegistry是一个基于内存的注册表，它不支持导出数据到监控系统，主要用来进行本地开发和测试。</p>
<p>Micrometer支持多个不同的监控系统，通过CompositeMeterRegistry可以把多个计量器注册表组合起来，从而允许同时发布数据到多个监控系统中。</p>
<pre><code>public void compositeRegistry(){
        CompositeMeterRegistry compositeMeterRegistry = new CompositeMeterRegistry();
        compositeMeterRegistry.add(new SimpleMeterRegistry());
        compositeMeterRegistry.add(new SimpleMeterRegistry(new SimpleConfig() {
            @Override
            public String get(String s) {
                return null;
            }

            //增加前缀
            @Override
            public String prefix() {
                return &quot;simple&quot;;
            }
        },Clock.SYSTEM));

        Counter counter = compositeMeterRegistry.counter(&quot;test&quot;);
        counter.increment();
    }
</code></pre><p>Micrometer本身提供了一个静态的全局注册表Metrics.golbalRegistry。这个注册表一个组合注册表，使用Metrics类中的静态方法创建的计量器，都会被添加到这个全局注册表中</p>
<pre><code>public void globalRegistry(){
    Metrics.addRegistry(simpleMeterRegistry);
    Counter global = Metrics.counter(&quot;global&quot;);
    global.increment();
}
</code></pre><h2 id="SpringBoot-Actuator"><a href="#SpringBoot-Actuator" class="headerlink" title="SpringBoot Actuator"></a>SpringBoot Actuator</h2><p>上述介绍了Micrometer的一些简单使用，从Spring Boot2.0开始，Micrometer就是Spring Boot默认提供的性能指标收集库。SpringBoot Actuator提供了对Micrometer的自动配置。在项目中引入SpringBoot Actuator，</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre><p>并在配置文件中，增加如下配置</p>
<pre><code>Actuator可对外默认的服务，*表示显示所有
management.endpoints.web.exposure.include=*
</code></pre><p>启动项目，访问<a href="http://8080/actuator,就可以看到Actuator提供的所有监控" target="_blank" rel="noopener">http://8080/actuator,就可以看到Actuator提供的所有监控</a></p>
<pre><code>{
  &quot;_links&quot;: {
    &quot;self&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator&quot;,
      &quot;templated&quot;: false
    },
    &quot;auditevents&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/auditevents&quot;,
      &quot;templated&quot;: false
    },
    &quot;beans&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/beans&quot;,
      &quot;templated&quot;: false
    },
    &quot;caches-cache&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/caches/{cache}&quot;,
      &quot;templated&quot;: true
    },
    &quot;caches&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/caches&quot;,
      &quot;templated&quot;: false
    },
    &quot;health&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/health&quot;,
      &quot;templated&quot;: false
    },
    &quot;health-component&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/health/{component}&quot;,
      &quot;templated&quot;: true
    },
    &quot;health-component-instance&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/health/{component}/{instance}&quot;,
      &quot;templated&quot;: true
    },
    &quot;conditions&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/conditions&quot;,
      &quot;templated&quot;: false
    },
    &quot;configprops&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/configprops&quot;,
      &quot;templated&quot;: false
    },
    &quot;env&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/env&quot;,
      &quot;templated&quot;: false
    },
    &quot;env-toMatch&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/env/{toMatch}&quot;,
      &quot;templated&quot;: true
    },
    &quot;info&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/info&quot;,
      &quot;templated&quot;: false
    },
    &quot;loggers&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/loggers&quot;,
      &quot;templated&quot;: false
    },
    &quot;loggers-name&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/loggers/{name}&quot;,
      &quot;templated&quot;: true
    },
    &quot;heapdump&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/heapdump&quot;,
      &quot;templated&quot;: false
    },
    &quot;threaddump&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/threaddump&quot;,
      &quot;templated&quot;: false
    },
    &quot;prometheus&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/prometheus&quot;,
      &quot;templated&quot;: false
    },
    &quot;metrics&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/metrics&quot;,
      &quot;templated&quot;: false
    },
    &quot;metrics-requiredMetricName&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/metrics/{requiredMetricName}&quot;,
      &quot;templated&quot;: true
    },
    &quot;scheduledtasks&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/scheduledtasks&quot;,
      &quot;templated&quot;: false
    },
    &quot;httptrace&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/httptrace&quot;,
      &quot;templated&quot;: false
    },
    &quot;mappings&quot;: {
      &quot;href&quot;: &quot;http://localhost:8080/actuator/mappings&quot;,
      &quot;templated&quot;: false
    }
  }
}
</code></pre><p>访问<a href="http://localhost:8080/actuator/metrics，可以看到Actuator默认收集的监控指标，包括JVM相关指标(内存使用，垃圾收集)，tomcat相关指标，数据库连接池还是系统相关指标" target="_blank" rel="noopener">http://localhost:8080/actuator/metrics，可以看到Actuator默认收集的监控指标，包括JVM相关指标(内存使用，垃圾收集)，tomcat相关指标，数据库连接池还是系统相关指标</a></p>
<pre><code>{
  &quot;names&quot;: [
    &quot;jvm.memory.max&quot;,
    &quot;jvm.threads.states&quot;,
    &quot;process.files.max&quot;,
    &quot;jvm.gc.memory.promoted&quot;,
    &quot;system.load.average.1m&quot;,
    &quot;jvm.memory.used&quot;,
    &quot;jvm.gc.max.data.size&quot;,
    &quot;jvm.gc.pause&quot;,
    &quot;jvm.memory.committed&quot;,
    &quot;system.cpu.count&quot;,
    &quot;logback.events&quot;,
    &quot;tomcat.global.sent&quot;,
    &quot;jvm.buffer.memory.used&quot;,
    &quot;tomcat.sessions.created&quot;,
    &quot;jvm.threads.daemon&quot;,
    &quot;system.cpu.usage&quot;,
    &quot;jvm.gc.memory.allocated&quot;,
    &quot;tomcat.global.request.max&quot;,
    &quot;tomcat.global.request&quot;,
    &quot;tomcat.sessions.expired&quot;,
    &quot;jvm.threads.live&quot;,
    &quot;jvm.threads.peak&quot;,
    &quot;tomcat.global.received&quot;,
    &quot;process.uptime&quot;,
    &quot;tomcat.sessions.rejected&quot;,
    &quot;process.cpu.usage&quot;,
    &quot;http.server.requests&quot;,
    &quot;tomcat.threads.config.max&quot;,
    &quot;jvm.classes.loaded&quot;,
    &quot;jvm.classes.unloaded&quot;,
    &quot;tomcat.global.error&quot;,
    &quot;tomcat.sessions.active.current&quot;,
    &quot;tomcat.sessions.alive.max&quot;,
    &quot;jvm.gc.live.data.size&quot;,
    &quot;tomcat.threads.current&quot;,
    &quot;process.files.open&quot;,
    &quot;jvm.buffer.count&quot;,
    &quot;jvm.buffer.total.capacity&quot;,
    &quot;tomcat.sessions.active.max&quot;,
    &quot;tomcat.threads.busy&quot;,
    &quot;process.start.time&quot;
  ]
}
</code></pre><p>我们可以通过以下链接来查看具体某个指标</p>
<pre><code>http://localhost:8080/actuator/metrics/metricName
</code></pre><p>其中metricName为需要查看指标的名称，例如查看jvm内存</p>
<pre><code> http://localhost:8080/actuator/metrics/jvm.memory.used
</code></pre><p><img src="https://raw.githubusercontent.com/BloodHunter/blog-comments/master/20190929110225.png" alt=""></p>
<p>从上图中我们可以看到jvm.memory.used有两个tag，area和id，area指定内存位置(堆内存和非堆内存)，id指定内存分类，我们可以指定tag来查看更细致的指标</p>
<pre><code>http://localhost:8080/actuator/metrics/jvm.memory.used?tag=area:heap
http://localhost:8080/actuator/metrics/jvm.memory.used?tag=area:heap&amp;tag=id:PS%20Eden%20Space
</code></pre><h2 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h2><p>Micrometer支持Prometheus，Micrometer提供PrometheusMeterRegistry注册表，用于将指标转为Prometheus格式的指标。首先需要在pom文件引入依赖</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
    &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre><p>其次在配置文件中，配置暴露Prometheus，并允许将指标导入到Prometheus中</p>
<pre><code>management.endpoint.prometheus.enabled=true
management.metrics.export.prometheus.enabled=true
</code></pre><p>项目启动后，我们访问<a href="http://localhost:8080/actuator/prometheus，可以看到指标以变成Prometheus格式的指标" target="_blank" rel="noopener">http://localhost:8080/actuator/prometheus，可以看到指标以变成Prometheus格式的指标</a><br><img src="https://raw.githubusercontent.com/BloodHunter/blog-comments/master/20190929113443.png" alt=""></p>
<p>可以安装Prometheus来采集这些指标</p>
<pre><code>docker run -d -p 9090:9090 -v ~/Documents/config/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus
</code></pre><p>其中prometheus.yml配置了采集地址及路径</p>
<pre><code>scrape_configs:
 - job_name: prometheus-test
   metrics_path: /actuator/prometheus
   static_configs:
   - targets: [&#39;172.16.22.50:8080&#39;]
</code></pre><p>172.16.22.50是我本机的地址，你们可以修改为自己的ip地址即可，访问<a href="http://localhost:9090/targets可以看到Prometheus采集配置" target="_blank" rel="noopener">http://localhost:9090/targets可以看到Prometheus采集配置</a><br><img src="https://raw.githubusercontent.com/BloodHunter/blog-comments/master/20190929135104.png" alt=""></p>
<h2 id="自定义Metric"><a href="#自定义Metric" class="headerlink" title="自定义Metric"></a>自定义Metric</h2><p>我们可以利用Prometheus client自定义metric</p>
<pre><code>package com.wbl.spingbootdemo.prometheus;

import io.prometheus.client.CollectorRegistry;
import io.prometheus.client.Counter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import javax.annotation.PostConstruct;

/**
 * @author wbl
 * @date 2019-09-29
 */
@Service
public class PrometheusMeter {

    @Autowired
    private CollectorRegistry collectorRegistry;

    // 定义name为prometheus_counter的counter
    public Counter prometheusCounter(){
        return Counter.build().name(&quot;prometheus_counter&quot;).help(&quot;prometheus counter test&quot;)
                .register(collectorRegistry);
    }

    @PostConstruct
    public void init(){
        Counter counter = prometheusCounter();
        new Thread(()-&gt; {
            while (true){
                counter.inc();
                try {
                    Thread.sleep(5000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }).start();
    }
}
</code></pre><p>启动项目之后，可以在Prometheus查询页面看到刚刚定义的指标prometheus_counter</p>
<p><img src="https://raw.githubusercontent.com/BloodHunter/blog-comments/master/20190929135241.png" alt=""></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>Micrometer整合了多个监控系统，包括Prometheus。Micrometer利用Meter收集数据，利用不同的MeterRegistry与不同的监控系统整合</li>
<li>SpringBoot Actuator集成了Micrometer，定义了许多默认的metric，可以在<a href="http://localhost:8080/actuator/metrics查看" target="_blank" rel="noopener">http://localhost:8080/actuator/metrics查看</a></li>
<li>SpringBoot Actuator可以通过Micrometer将采集的指标导入到Prometheus中</li>
</ol>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li><a href="http://micrometer.io/docs" target="_blank" rel="noopener">Micrometer</a></li>
<li><a href="https://www.baeldung.com/micrometer" target="_blank" rel="noopener">Quick Guide to Micrometer</a></li>
<li><a href="https://mucahit.io/2018/08/27/instrumenting-and-monitoring-spring-boot-2-applications/" target="_blank" rel="noopener">Instrumenting And Monitoring Spring Boot 2 Applications</a></li>
<li><a href="http://ylzheng.com/2018/01/24/use-prometheus-monitor-your-spring-boot-application/" target="_blank" rel="noopener">自定义Metrics：让Prometheus监控你的应用程序</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/java/j-using-micrometer-to-record-java-metric/index.html" target="_blank" rel="noopener">使用 Micrometer 记录 Java 应用性能指标</a></li>
</ul>

            </div>
            <hr>

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff;
        background-color: #22AB38;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff;
        background-color: #019FE8;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a class="reward-link btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs">
                        <li class="tab wechat-tab waves-effect waves-light"><a class="active" href="#wechat">微信</a></li>
                        <li class="tab alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                    </ul>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpeg" class="reward-img" alt="微信打赏二维码">
                    </div>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpeg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('#reward .reward-link').on('click', function () {
            $('#rewardModal').openModal();
        });

        $('#rewardModal .close').on('click', function () {
            $('#rewardModal').closeModal();
        });
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone, qq, weibo, douban"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            <div class="reprint">
                <p>
                    <span class="reprint-tip">Reprint please specify: </span>
                    <a href="http://yoursite.com" class="b-link-green">wbl</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2019/09/27/spring-boot-zheng-he-prometheus/" class="b-link-green">Spring Boot整合Prometheus</a>
                </p>
            </div>
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: '2ce6d5b3bf1afe6d63e1',
        clientSecret: '1adb94042a9ac66b08a7a774c10dfc1deb0cb0bd',
        repo: 'blog-comments',
        owner: 'BloodHunter',
        admin: "BloodHunter",
        id: '2019-09-27T19-24-58',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">Previous</div>
            <div class="card">
                <a href="/2019/10/11/prometheus-counter/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="Prometheus Counter">
                        
                        <span class="card-title">Prometheus Counter</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">我曾经以为Counter是prometheus中最简单的一种metric，直到我在Grafana中配置counter相关的dashboard之后，才发现自己对于counter的理解有一些偏差。因此这篇博客将会详细的介绍counter的用法。</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-10-11
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/监控/" class="post-category" target="_blank">
                                    监控
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Prometheus/" target="_blank">
                        <span class="chip bg-color">Prometheus</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">Next</div>
            <div class="card">
                <a href="/2019/09/12/redis-cache-with-spring-boot/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/18.jpg" class="responsive-img" alt="Redis cache with Spring Boot">
                        
                        <span class="card-title">Redis cache with Spring Boot</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">Spring Boot支持使用redis作为cache缓存，下面会详细介绍具体的用法
maven 依赖    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boo</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-09-12
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Spring-Boot/" class="post-category" target="_blank">
                                    Spring Boot
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Spring-Boot/" target="_blank">
                        <span class="chip bg-color">Spring Boot</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            本站基于
            <a href="https://hexo.io/" target="_blank">Hexo</a> 采用
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">hexo-theme-matery</a>的主题搭建.
        </div>
        <div class="col s12 m4 l4 social-link"><a href="https://github.com/BloodHunter" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
    <i class="fa fa-github"></i>
</a>
<a href="mailto:15201414128@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
    <i class="fa fa-envelope-open"></i>
</a>
<a href="#!" class="tooltipped" data-tooltip="QQ联系我: 765759638" data-position="top" data-delay="50">
    <i class="fa fa-qq"></i>
</a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title">Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword" class="search-input" autofocus>
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/js/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->


</body>
</html>